#!/bin/sh

MacVim=/Applications/MacPorts/MacVim.app
MacVimBin=$MacVim/Contents/MacOS/MacVim

function isLocal () {
	octet='\.\([0-9]\|[1-9][0-9]\|1[0-9][0-9]\|2[0-4][0-9]\|25[0-5]\)'
	expr "`echo "$SSH_CLIENT" | cut -d\  -f1`" : \
		'^\(\|\(\(10\|127\)'"$octet"'\|192\.168\)'"$octet$octet"'\)$' \
		>/dev/null
}

function isMac () {
	test "$TERM_PROGRAM" = Apple_Terminal -a \
			-z "$SSH_CLIENT" -a \
			-x $MacVimBin && \
		expr "$DISPLAY" : '^\(\|/.*launch.*\)$' >/dev/null
}

isf=false
for arg in "$@"
do
	if test x"$arg" = x-f
	then
		isf=true
	fi
done

UI=term
if isMac
then
	UI=mac
elif test ! -z "$DISPLAY" && isLocal
then
	UI=X
fi

case $UI in
	X)
		exec 0</dev/null
		exec 1>/dev/null
		exec 2>&1
		if test `uname` = Darwin && ! $isf
		then
			gvim "$@" &
		else
			exec gvim "$@"
		fi
		;;
	mac)
		unset DISPLAY
		exec 0</dev/null
		exec 1>/dev/null
		exec 2>&1
		$MacVimBin "$@" &
		sleep 2
		open $MacVim
		if $isf
		then
			wait
		fi
		;;
	term)
		unset DISPLAY
		exec vim "$@"
		;;
esac

